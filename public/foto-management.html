<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Management - WeightTracker Pro</title>
    <link rel="icon" type="image/png" href="/logo.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        :root {
            /* 🇮🇩 MERAH PUTIH - Indonesian Flag Theme */
            --primary-red: #ff3b3b;
            --primary-red-dark: #ce1126;  /* Official Indonesian Red */
            --primary-red-light: #ff8a8a;
            --bg-white: #ffffff;
            --bg-gray: #f5f7fa;
            --surface: #ffffff;
            --surface-light: #f9fafb;
            --text-primary: #2d3748;
            --text-secondary: #718096;
            --border-color: rgba(0, 0, 0, 0.1);
            --shadow-3d: 8px 8px 16px rgba(0, 0, 0, 0.1), -4px -4px 8px rgba(255, 255, 255, 0.9);
            --border-radius: 16px;
            --red-success: #ff6b6b;  /* Light red for success */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 11px;
            background: var(--bg-gray);
            color: var(--text-primary);
            overflow-x: hidden;
            min-height: 100vh;
            padding: 20px;
        }

        .container-fluid {
            max-width: 1600px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: var(--surface);
            border-radius: var(--border-radius);
            padding: 24px 28px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-3d);
            border-top: 4px solid var(--primary-red);
            transition: all 0.3s;
        }

        .header:hover {
            box-shadow: 12px 12px 24px rgba(0, 0, 0, 0.12), -6px -6px 12px rgba(255, 255, 255, 1);
        }

        .header-title {
            font-size: 26px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .header-title i {
            color: var(--primary-red);
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--surface);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow-3d);
            border: 1px solid var(--border-color);
            text-align: center;
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 12px 12px 24px rgba(0, 0, 0, 0.12), -6px -6px 12px rgba(255, 255, 255, 1);
        }

        .stat-value {
            font-size: 26px;
            font-weight: 700;
            color: var(--primary-red);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 13px;
            margin-top: 4px;
        }

        /* Filter Card */
        .filter-card {
            background: var(--surface);
            border-radius: var(--border-radius);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-3d);
            border: 1px solid var(--border-color);
        }

        .filter-card h5 {
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .filter-card h5 i {
            color: var(--primary-red);
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .filter-label {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 6px;
        }

        .holographic-input {
            background: var(--surface);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 10px;
            padding: 10px 14px;
            font-size: 11px;
            width: 100%;
            transition: all 0.3s;
        }

        .holographic-input:focus {
            border-color: var(--primary-red);
            box-shadow: 0 0 0 3px rgba(255, 59, 59, 0.1);
            outline: none;
        }

        /* Buttons */
        .btn-holographic {
            background: var(--primary-red);
            border: none;
            color: white;
            padding: 10px 20px;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 11px;
            box-shadow: 0 4px 12px rgba(255, 59, 59, 0.3);
        }

        .btn-holographic:hover {
            background: var(--primary-red-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(255, 59, 59, 0.4);
        }

        .btn-danger {
            /* 🇮🇩 Dark Red for Delete */
            background: var(--primary-red-dark);
            box-shadow: 0 4px 12px rgba(206, 17, 38, 0.3);
        }

        .btn-danger:hover {
            background: #a00f1f;
            box-shadow: 0 6px 16px rgba(206, 17, 38, 0.4);
        }

        .btn-success {
            /* 🇮🇩 Light Red for Download */
            background: var(--primary-red);
            box-shadow: 0 4px 12px rgba(255, 59, 59, 0.3);
        }

        .btn-success:hover {
            background: var(--primary-red-dark);
            box-shadow: 0 6px 16px rgba(255, 59, 59, 0.4);
        }

        .action-bar {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 24px;
        }

        /* Photo Gallery */
        .photo-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .photo-card {
            background: var(--surface);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow-3d);
            border: 1px solid var(--border-color);
            transition: all 0.3s;
            position: relative;
        }

        .photo-card:hover {
            transform: translateY(-5px);
            box-shadow: 12px 12px 24px rgba(0, 0, 0, 0.12), -6px -6px 12px rgba(255, 255, 255, 1);
        }

        .photo-card.selected {
            border: 2px solid var(--primary-red);
            box-shadow: 0 0 20px rgba(255, 59, 59, 0.3);
        }

        .photo-checkbox {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 10;
            width: 24px;
            height: 24px;
            cursor: pointer;
        }

        .photo-img-container {
            width: 100%;
            height: 220px;
            overflow: hidden;
            position: relative;
            background: var(--bg-gray);
        }

        .photo-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s;
        }

        .photo-card:hover .photo-img {
            transform: scale(1.05);
        }

        .photo-info {
            padding: 14px;
        }

        .photo-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 11px;
        }

        .photo-date {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .photo-size {
            font-size: 11px;
            color: var(--primary-red);
            font-weight: 500;
        }

        .photo-actions {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .btn-small {
            padding: 6px 10px;
            font-size: 11px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
        }

        .btn-view {
            /* 🇮🇩 Red for View */
            background: rgba(255, 59, 59, 0.1);
            color: var(--primary-red);
            border: 1px solid var(--primary-red);
        }

        .btn-view:hover {
            background: var(--primary-red);
            color: white;
        }

        .btn-download {
            /* 🇮🇩 Light Red for Download */
            background: rgba(255, 138, 138, 0.1);
            color: var(--red-success);
            border: 1px solid var(--red-success);
        }

        .btn-download:hover {
            background: var(--red-success);
            color: white;
        }

        .btn-delete {
            /* 🇮🇩 Dark Red for Delete */
            background: rgba(206, 17, 38, 0.1);
            color: var(--primary-red-dark);
            border: 1px solid var(--primary-red-dark);
        }

        .btn-delete:hover {
            background: var(--primary-red-dark);
            color: white;
        }

        /* States */
        .loading, .no-photos {
            text-align: center;
            padding: 60px;
            color: var(--text-secondary);
        }

        .loading i, .no-photos i {
            color: var(--primary-red);
        }

        /* Lazy Loading Skeleton */
        .photo-img.lazy-loading {
            background: linear-gradient(
                90deg,
                var(--bg-gray) 25%,
                #e5e7eb 50%,
                var(--bg-gray) 75%
            );
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .photo-img.loaded {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Lightbox */
        .lightbox {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .lightbox.active {
            display: flex;
        }

        .lightbox-content {
            position: relative;
            max-width: 90%;
            max-height: 90%;
        }

        .lightbox-img {
            max-width: 100%;
            max-height: 90vh;
            border-radius: 8px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .lightbox-close {
            position: absolute;
            top: -40px;
            right: 0;
            background: var(--primary-red);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s;
        }

        .lightbox-close:hover {
            background: var(--primary-red-dark);
            transform: rotate(90deg);
        }

        .lightbox-loading {
            color: white;
            font-size: 18px;
        }

        .lightbox-loading i {
            font-size: 40px;
            margin-bottom: 10px;
        }

        /* Progress Modal */
        .progress-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .progress-modal.active {
            display: flex;
        }

        .progress-modal-content {
            background: var(--surface);
            border-radius: var(--border-radius);
            padding: 40px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            text-align: center;
        }

        .progress-modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .progress-modal-subtitle {
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 24px;
        }

        .progress-bar-container {
            width: 100%;
            height: 40px;
            background: var(--bg-gray);
            border-radius: 20px;
            overflow: hidden;
            margin-bottom: 16px;
            position: relative;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-red), var(--primary-red-light));
            border-radius: 20px;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 11px;
        }

        .progress-status {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 8px;
        }

        .progress-spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 4px solid var(--bg-gray);
            border-top: 4px solid var(--primary-red);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* View Mode Toggle */
        .view-mode-toggle {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-bottom: 16px;
        }

        .view-mode-btn {
            background: var(--surface);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .view-mode-btn:hover {
            background: var(--primary-red);
            color: white;
            border-color: var(--primary-red);
        }

        .view-mode-btn.active {
            background: var(--primary-red);
            color: white;
            border-color: var(--primary-red);
            box-shadow: 0 4px 12px rgba(255, 59, 59, 0.3);
        }

        /* Virtual Scroll Container */
        .virtual-scroll-container {
            position: relative;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .virtual-scroll-spacer {
            position: absolute;
            top: 0;
            left: 0;
            width: 1px;
            pointer-events: none;
        }

        .virtual-scroll-content {
            position: relative;
            will-change: transform;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 24px;
        }

        .pagination button {
            background: var(--surface);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px 14px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 13px;
        }

        .pagination button:hover:not(:disabled) {
            background: var(--primary-red);
            color: white;
            border-color: var(--primary-red);
        }

        .pagination button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .pagination button.active {
            background: var(--primary-red);
            color: white;
            border-color: var(--primary-red);
        }

        /* Responsive */
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }

            .header {
                padding: 20px;
            }

            .header-title {
                font-size: 22px;
            }

            .photo-gallery {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }

            .photo-img-container {
                height: 180px;
            }

            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (min-width: 640px) {
            body {
                padding: 32px;
            }

            .header {
                padding: 28px 32px;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="header-title">
                        <i class="fas fa-images me-2"></i>
                        Photo Management
                    </h1>
                    <p style="color: var(--text-secondary); font-size: 11px;">Kelola foto dari Cloudinary dengan mudah</p>
                </div>
                <button class="btn-holographic" onclick="window.location.href='/data-management.html'">
                    <i class="fas fa-arrow-left me-2"></i> Back
                </button>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalPhotos">0</div>
                <div class="stat-label">Total Photos</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="selectedCount">0</div>
                <div class="stat-label">Selected</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="todayPhotos">0</div>
                <div class="stat-label">Uploaded Today</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalSize">0 MB</div>
                <div class="stat-label">Total Size</div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filter-card">
            <h5 class="mb-3">
                <i class="fas fa-filter me-2"></i> Filters & Search
            </h5>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; margin-bottom: 16px;">
                <div>
                    <div class="filter-label"><i class="fas fa-calendar-alt me-1"></i> Start Date</div>
                    <input type="date" class="holographic-input" id="startDate">
                </div>
                <div>
                    <div class="filter-label"><i class="fas fa-calendar-check me-1"></i> End Date</div>
                    <input type="date" class="holographic-input" id="endDate">
                </div>
                <div style="grid-column: span 2;">
                    <div class="filter-label"><i class="fas fa-search me-1"></i> Search Filename or Name</div>
                    <input type="text" class="holographic-input" id="searchInput" placeholder="Ketik minimal 3 karakter untuk search...">
                </div>
            </div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn-holographic" onclick="applyFilters()">
                    <i class="fas fa-search me-2"></i> Terapkan Filter
                </button>
                <button class="btn-holographic" onclick="resetFilters()">
                    <i class="fas fa-redo me-2"></i> Reset
                </button>
                <div style="flex: 1; min-width: 150px; text-align: right; padding: 10px 0; color: var(--text-secondary); font-size: 13px;">
                    <i class="fas fa-info-circle me-1"></i>
                    Showing <strong id="filteredCount">0</strong> of <strong id="totalCount">0</strong> photos
                    <span id="virtualScrollInfo" style="display: none; color: var(--primary-red); margin-left: 10px;">
                        <i class="fas fa-bolt"></i> <strong id="renderedCount">0</strong> rendered
                    </span>
                </div>
            </div>
        </div>

        <!-- Controls Bar: Pagination/View Mode (Left) + Export/Delete (Right) -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 20px; flex-wrap: wrap;">
            <!-- Left Side: View Mode Toggle + Pagination -->
            <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                <div class="view-mode-toggle" style="margin: 0;">
                    <button class="view-mode-btn active" id="paginationModeBtn" onclick="switchViewMode('pagination')">
                        <i class="fas fa-th"></i> Mode 500 Foto
                    </button>
                    <button class="view-mode-btn" id="infiniteModeBtn" onclick="switchViewMode('infinite')">
                        <i class="fas fa-infinity"></i> Tampilkan 2000 Foto (Virtual)
                    </button>
                </div>
                <div class="pagination" id="paginationTop" style="margin: 0;"></div>
            </div>

            <!-- Right Side: Select All/Unselect + Download/Delete Buttons -->
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                <button class="btn-holographic" onclick="selectAll()">
                    <i class="fas fa-check-square me-2"></i> Pilih All
                </button>
                <button class="btn-holographic" onclick="unselectAll()">
                    <i class="fas fa-square me-2"></i> Gak Pilih All
                </button>
                <button class="btn-holographic btn-success" onclick="downloadSelected()" id="btnDownload">
                    <i class="fas fa-download me-2"></i> Unduh Mang!
                </button>
                <button class="btn-holographic btn-danger" onclick="deleteSelected()" id="btnDelete">
                    <i class="fas fa-trash me-2"></i> Hapus Mang?
                </button>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="loading">
            <i class="fas fa-spinner fa-spin fa-3x mb-3"></i>
            <div>Loading photos from Cloudinary...</div>
        </div>

        <!-- Photo Gallery -->
        <div id="photoGallery" class="photo-gallery" style="display: none;">
        </div>

        <!-- No Photos State -->
        <div id="noPhotosState" class="no-photos" style="display: none;">
            <i class="fas fa-image fa-3x mb-3"></i>
            <div>No photos found</div>
        </div>

        <!-- Pagination -->
        <div class="pagination" id="pagination"></div>
    </div>

    <!-- Lightbox -->
    <div class="lightbox" id="lightbox" onclick="closeLightbox()">
        <div class="lightbox-content" onclick="event.stopPropagation()">
            <button class="lightbox-close" onclick="closeLightbox()">
                <i class="fas fa-times"></i>
            </button>
            <div class="lightbox-loading" id="lightboxLoading">
                <i class="fas fa-spinner fa-spin"></i>
                <div>Loading full-size image...</div>
            </div>
            <img id="lightboxImg" class="lightbox-img" style="display: none;" />
        </div>
    </div>

    <!-- Progress Modal -->
    <div class="progress-modal" id="progressModal">
        <div class="progress-modal-content">
            <div class="progress-spinner"></div>
            <div class="progress-modal-title" id="progressTitle">Preparing download...</div>
            <div class="progress-modal-subtitle" id="progressSubtitle">This may take a few moments</div>
            <div class="progress-bar-container">
                <div class="progress-bar-fill" id="progressBarFill" style="width: 0%;">
                    <span id="progressPercent">0%</span>
                </div>
            </div>
            <div class="progress-status" id="progressStatus">Initializing...</div>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURATION
        // ==========================================
        const SUPABASE_URL = 'https://lvsfcxfrvtsjkhbpgllq.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx2c2ZjeGZydnRzamtoYnBnbGxxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwNDczNzAsImV4cCI6MjA3MzYyMzM3MH0.VC9Bv8eUAak4jX5Vmwd-jJUPPfb-fGYdEX33qfwHelQ';
        const CLOUDINARY_CLOUD_NAME = 'dl6xk437w';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // State
        let allPhotos = [];
        let filteredPhotos = [];
        let selectedPhotos = new Set();
        let currentPage = 1;
        const photosPerPage = 50;

        // View Mode State
        let viewMode = 'pagination'; // 'pagination' or 'infinite'

        // Virtual Scroll State
        let virtualScrollState = {
            scrollTop: 0,
            visibleStart: 0,
            visibleEnd: 0,
            itemHeight: 360, // approx height of photo card (220px img + 140px info + margins)
            itemsPerRow: 4, // will be calculated dynamically
            buffer: 2, // extra rows to render above/below viewport
            containerHeight: 0,
            gap: 20 // match CSS grid gap
        };

        // ==========================================
        // FETCH PHOTOS FROM BACKEND API
        // ==========================================
        async function fetchPhotos() {
            try {
                document.getElementById('loadingState').style.display = 'block';
                document.getElementById('photoGallery').style.display = 'none';
                document.getElementById('noPhotosState').style.display = 'none';

                // Get auth token
                const token = localStorage.getItem('accessToken');
                if (!token) {
                    throw new Error('No access token found. Please login again.');
                }

                console.log('📸 Fetching photos from API...');

                // Fetch from backend API (fetches ALL photos - no pagination for foto-management)
                const response = await fetch('/api/foto-management/photos?limit=10000', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();

                console.log('📦 API Response:', result);

                if (!result.success) {
                    throw new Error(result.message || 'API request failed');
                }

                const data = result.data || [];

                // Transform data - pisahkan foto_url_1 dan foto_url_2
                allPhotos = [];
                data.forEach(entry => {
                    if (entry.foto_url_1) {
                        allPhotos.push({
                            id: `${entry.id}-1`,
                            entryId: entry.id,
                            url: entry.foto_url_1,
                            nama: entry.nama,
                            created_at: entry.created_at,
                            type: 'foto_1'
                        });
                    }
                    if (entry.foto_url_2) {
                        allPhotos.push({
                            id: `${entry.id}-2`,
                            entryId: entry.id,
                            url: entry.foto_url_2,
                            nama: entry.nama,
                            created_at: entry.created_at,
                            type: 'foto_2'
                        });
                    }
                });

                console.log('✅ Loaded photos:', allPhotos.length);

                filteredPhotos = [...allPhotos];
                updateStats();
                renderGallery();

            } catch (error) {
                console.error('❌ Error fetching photos:', error);
                document.getElementById('loadingState').innerHTML =
                    '<i class="fas fa-exclamation-triangle fa-3x mb-3"></i><div>Error loading photos: ' + error.message + '</div>';
            }
        }

        // ==========================================
        // UPDATE STATISTICS
        // ==========================================
        function updateStats() {
            document.getElementById('totalPhotos').textContent = allPhotos.length;
            document.getElementById('selectedCount').textContent = selectedPhotos.size;
            document.getElementById('totalCount').textContent = allPhotos.length;
            document.getElementById('filteredCount').textContent = filteredPhotos.length;

            // Today's photos
            const today = new Date().toISOString().split('T')[0];
            const todayCount = allPhotos.filter(photo =>
                photo.created_at && photo.created_at.startsWith(today)
            ).length;
            document.getElementById('todayPhotos').textContent = todayCount;

            // Calculate total size (estimate 500KB per image)
            const totalSizeMB = (allPhotos.length * 0.5).toFixed(2);
            document.getElementById('totalSize').textContent = `${totalSizeMB} MB`;
        }

        // ==========================================
        // CLOUDINARY THUMBNAIL HELPER
        // ==========================================
        function createThumbnailUrl(originalUrl) {
            // Check if URL is from Cloudinary
            if (!originalUrl || !originalUrl.includes('cloudinary.com')) {
                return originalUrl;
            }

            // Inject transformations after '/upload/'
            // w_300 = width 300px
            // h_300 = height 300px
            // c_fill = crop fill
            // q_auto = auto quality
            // f_auto = auto format (WebP for modern browsers)
            const thumbnailUrl = originalUrl.replace(
                '/upload/',
                '/upload/w_300,h_300,c_fill,q_auto,f_auto/'
            );

            return thumbnailUrl;
        }

        // ==========================================
        // RENDER GALLERY WITH LAZY LOADING
        // ==========================================
        function renderGallery() {
            const gallery = document.getElementById('photoGallery');
            const startIndex = (currentPage - 1) * photosPerPage;
            const endIndex = startIndex + photosPerPage;
            const pagePhotos = filteredPhotos.slice(startIndex, endIndex);

            if (filteredPhotos.length === 0) {
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('photoGallery').style.display = 'none';
                document.getElementById('noPhotosState').style.display = 'block';
                return;
            }

            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('photoGallery').style.display = 'grid';
            document.getElementById('noPhotosState').style.display = 'none';

            // Reset styles for pagination mode (undo virtual scroll styles)
            gallery.style.minHeight = '';
            gallery.style.position = '';
            gallery.style.width = '';

            gallery.innerHTML = pagePhotos.map(photo => {
                const date = new Date(photo.created_at);
                const dateStr = date.toLocaleDateString('id-ID');
                const timeStr = date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
                const isSelected = selectedPhotos.has(photo.id);

                // Generate thumbnail URL (300x300 optimized)
                const thumbnailUrl = createThumbnailUrl(photo.url);
                // Keep full-size URL for lightbox
                const fullSizeUrl = photo.url;

                // Get filename from URL
                const urlParts = photo.url.split('/');
                const filename = urlParts[urlParts.length - 1];

                // Placeholder SVG for lazy loading
                const placeholderSvg = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 300 300'%3E%3Crect fill='%23f5f7fa'/%3E%3C/svg%3E";

                return `
                    <div class="photo-card ${isSelected ? 'selected' : ''}" id="card-${photo.id}">
                        <input type="checkbox"
                            class="photo-checkbox"
                            ${isSelected ? 'checked' : ''}
                            onchange="toggleSelect('${photo.id}')"
                        >
                        <div class="photo-img-container">
                            <img src="${placeholderSvg}"
                                data-src="${thumbnailUrl}"
                                data-full="${fullSizeUrl}"
                                alt="${photo.nama}"
                                class="photo-img lazy-loading"
                                onerror="this.src='https://via.placeholder.com/250?text=Error+Loading'"
                            >
                        </div>
                        <div class="photo-info">
                            <div class="photo-name" title="${photo.nama}">${photo.nama}</div>
                            <div class="photo-date">${dateStr} ${timeStr}</div>
                            <div class="photo-size">${photo.type} • Thumbnail</div>
                            <div class="photo-actions">
                                <button class="btn-small btn-view" onclick="viewPhotoLightbox('${fullSizeUrl}')">
                                    <i class="fas fa-eye"></i> View
                                </button>
                                <button class="btn-small btn-download" onclick="downloadPhoto('${fullSizeUrl}', '${filename}')">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button class="btn-small btn-delete" onclick="deletePhoto('${photo.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Initialize lazy loading after rendering
            initLazyLoading();
            renderPagination();
            updateStats();

            // Hide virtual scroll info in pagination mode
            document.getElementById('virtualScrollInfo').style.display = 'none';
        }

        // ==========================================
        // LAZY LOADING WITH INTERSECTION OBSERVER
        // ==========================================
        let imageObserver = null;

        function initLazyLoading() {
            // Disconnect previous observer if exists
            if (imageObserver) {
                imageObserver.disconnect();
            }

            // Create new Intersection Observer
            imageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        const thumbnailUrl = img.dataset.src;

                        // Load thumbnail
                        img.src = thumbnailUrl;

                        // Remove lazy-loading class and add loaded class when image loads
                        img.onload = function() {
                            img.classList.remove('lazy-loading');
                            img.classList.add('loaded');
                        };

                        // Stop observing this image
                        observer.unobserve(img);
                    }
                });
            }, {
                rootMargin: '50px' // Start loading 50px before image enters viewport
            });

            // Observe all lazy images
            document.querySelectorAll('.photo-img.lazy-loading').forEach(img => {
                imageObserver.observe(img);
            });
        }

        // ==========================================
        // PAGINATION
        // ==========================================
        function renderPagination() {
            const pagination = document.getElementById('pagination');
            const paginationTop = document.getElementById('paginationTop');
            const totalPages = Math.ceil(filteredPhotos.length / photosPerPage);

            if (totalPages <= 1) {
                if (pagination) pagination.innerHTML = '';
                if (paginationTop) paginationTop.innerHTML = '';
                return;
            }

            let html = `
                <button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
                    <i class="fas fa-chevron-left"></i>
                </button>
            `;

            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    html += `
                        <button onclick="changePage(${i})" class="${i === currentPage ? 'active' : ''}">
                            ${i}
                        </button>
                    `;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    html += '<span style="color: var(--text-secondary);">...</span>';
                }
            }

            html += `
                <button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
                    <i class="fas fa-chevron-right"></i>
                </button>
            `;

            // Update both pagination elements
            if (pagination) pagination.innerHTML = html;
            if (paginationTop) paginationTop.innerHTML = html;
        }

        function changePage(page) {
            const totalPages = Math.ceil(filteredPhotos.length / photosPerPage);
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            renderGallery();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ==========================================
        // SELECTION FUNCTIONS
        // ==========================================
        function toggleSelect(photoId) {
            if (selectedPhotos.has(photoId)) {
                selectedPhotos.delete(photoId);
            } else {
                selectedPhotos.add(photoId);
            }
            updateStats();

            const card = document.getElementById(`card-${photoId}`);
            if (card) {
                card.classList.toggle('selected');
            }
        }

        function selectAll() {
            if (viewMode === 'pagination') {
                // Select only photos on current page
                const startIndex = (currentPage - 1) * photosPerPage;
                const endIndex = startIndex + photosPerPage;
                const pagePhotos = filteredPhotos.slice(startIndex, endIndex);

                pagePhotos.forEach(photo => selectedPhotos.add(photo.id));
                console.log(`✅ Selected ${pagePhotos.length} photos on current page`);

                // Update UI
                pagePhotos.forEach(photo => {
                    const card = document.getElementById(`card-${photo.id}`);
                    if (card) {
                        card.classList.add('selected');
                        const checkbox = card.querySelector('.photo-checkbox');
                        if (checkbox) checkbox.checked = true;
                    }
                });
            } else {
                // Infinite scroll mode - select visible photos
                const { visibleStart, visibleEnd } = virtualScrollState;
                const visiblePhotos = filteredPhotos.slice(visibleStart, visibleEnd);

                visiblePhotos.forEach(photo => selectedPhotos.add(photo.id));
                console.log(`✅ Selected ${visiblePhotos.length} visible photos`);

                // Update UI
                visiblePhotos.forEach(photo => {
                    const card = document.getElementById(`card-${photo.id}`);
                    if (card) {
                        card.classList.add('selected');
                        const checkbox = card.querySelector('.photo-checkbox');
                        if (checkbox) checkbox.checked = true;
                    }
                });
            }

            updateStats();
        }

        function unselectAll() {
            const previousSize = selectedPhotos.size;
            selectedPhotos.clear();

            console.log(`✅ Unselected ${previousSize} photos`);
            updateStats();

            // Update UI - remove selected class and uncheck all checkboxes
            document.querySelectorAll('.photo-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelectorAll('.photo-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
        }

        // ==========================================
        // FILTER FUNCTIONS
        // ==========================================
        function applyFilters() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const search = document.getElementById('searchInput').value.toLowerCase();

            filteredPhotos = allPhotos.filter(photo => {
                const photoDate = new Date(photo.created_at).toISOString().split('T')[0];
                
                if (startDate && photoDate < startDate) return false;
                if (endDate && photoDate > endDate) return false;
                if (search && !photo.nama.toLowerCase().includes(search) && 
                    !photo.url.toLowerCase().includes(search)) return false;

                return true;
            });

            currentPage = 1;
            renderGallery();
        }

        function resetFilters() {
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('searchInput').value = '';
            filteredPhotos = [...allPhotos];
            currentPage = 1;
            renderGallery();
        }

        // ==========================================
        // LIGHTBOX FUNCTIONS
        // ==========================================
        function viewPhotoLightbox(fullSizeUrl) {
            const lightbox = document.getElementById('lightbox');
            const lightboxImg = document.getElementById('lightboxImg');
            const lightboxLoading = document.getElementById('lightboxLoading');

            // Show lightbox
            lightbox.classList.add('active');
            lightboxLoading.style.display = 'block';
            lightboxImg.style.display = 'none';

            // Preload full-size image
            const img = new Image();
            img.onload = function() {
                lightboxImg.src = fullSizeUrl;
                lightboxImg.style.display = 'block';
                lightboxLoading.style.display = 'none';
            };
            img.onerror = function() {
                lightboxLoading.innerHTML = '<i class="fas fa-exclamation-triangle"></i><div>Error loading image</div>';
            };
            img.src = fullSizeUrl;
        }

        function closeLightbox() {
            const lightbox = document.getElementById('lightbox');
            const lightboxImg = document.getElementById('lightboxImg');
            lightbox.classList.remove('active');
            lightboxImg.src = ''; // Clear image
        }

        // Close lightbox with ESC key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeLightbox();
            }
        });

        // ==========================================
        // PHOTO ACTIONS
        // ==========================================
        async function downloadPhoto(url, filename) {
            try {
                console.log('Downloading:', url);

                // Method 1: Try fetch + blob (works with CORS)
                try {
                    const response = await fetch(url);
                    const blob = await response.blob();
                    const blobUrl = window.URL.createObjectURL(blob);

                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = blobUrl;
                    a.download = filename || 'photo.jpg';
                    document.body.appendChild(a);
                    a.click();

                    // Cleanup
                    setTimeout(() => {
                        window.URL.revokeObjectURL(blobUrl);
                        document.body.removeChild(a);
                    }, 100);

                    console.log('✅ Download success via fetch+blob');
                } catch (fetchError) {
                    console.warn('Fetch failed, trying direct download:', fetchError);

                    // Method 2: Direct download (fallback)
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename || 'photo.jpg';
                    a.target = '_blank';
                    a.rel = 'noopener noreferrer';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);

                    console.log('✅ Download success via direct link');
                }
            } catch (error) {
                console.error('❌ Download error:', error);
                alert('Error downloading photo. Please try right-click > Save Image As...');
            }
        }

        async function deletePhoto(photoId) {
            if (!confirm('Hapus foto ini?')) return;

            try {
                const photo = allPhotos.find(p => p.id === photoId);
                if (!photo) return;

                // Get auth token
                const token = localStorage.getItem('accessToken');
                if (!token) {
                    throw new Error('No access token found. Please login again.');
                }

                const field = photo.type === 'foto_1' ? 'foto_url_1' : 'foto_url_2';
                console.log(`🗑️ Deleting photo: entry ${photo.entryId}, field ${field}`);

                // Delete via API
                const response = await fetch(`/api/foto-management/photos/${photo.entryId}/${field}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.message || 'Delete failed');
                }

                console.log('✅ Photo deleted successfully');

                alert('✅ Foto berhasil dihapus dari database!');
                fetchPhotos();
            } catch (error) {
                console.error('❌ Delete error:', error);
                alert('❌ Error deleting photo: ' + error.message);
            }
        }

        // ==========================================
        // PROGRESS MODAL HELPERS
        // ==========================================
        function showProgressModal() {
            document.getElementById('progressModal').classList.add('active');
        }

        function hideProgressModal() {
            document.getElementById('progressModal').classList.remove('active');
        }

        function updateProgress(percent, title, subtitle, status) {
            document.getElementById('progressBarFill').style.width = `${percent}%`;
            document.getElementById('progressPercent').textContent = `${percent}%`;
            if (title) document.getElementById('progressTitle').textContent = title;
            if (subtitle) document.getElementById('progressSubtitle').textContent = subtitle;
            if (status) document.getElementById('progressStatus').textContent = status;
        }

        // ==========================================
        // BATCH ACTIONS - ZIP DOWNLOAD
        // ==========================================
        async function downloadSelected() {
            if (selectedPhotos.size === 0) {
                alert('⚠️ Pilih foto terlebih dahulu!');
                return;
            }

            // Get selected photos from FILTERED list (not all photos)
            const photos = filteredPhotos.filter(p => selectedPhotos.has(p.id));

            if (photos.length === 0) {
                alert('⚠️ Tidak ada foto yang dipilih di halaman ini!');
                return;
            }

            // Optional warning for large batches
            if (photos.length > 1000) {
                const proceed = confirm(
                    `⚠️ HAYU ATUH!\n\n` +
                    `Akang mau download ${photos.length} foto teh!\n` +
                    `Ieu mah LOBA PISAN euy! Bisa:\n` +
                    `- Ngantosan 5-10 menit\n` +
                    `- Makeunkeun memory 1GB+\n` +
                    `- Browser teh bisa rusak\n\n` +
                    `Yakin atuh?`
                );
                if (!proceed) return;
            }

            const confirmMsg = `Download ${photos.length} foto sebagai ZIP file?\n\nSemua foto akan di-bundle jadi 1 file .zip`;
            if (!confirm(confirmMsg)) return;

            console.log(`📦 Starting ZIP creation with ${photos.length} photos...`);

            try {
                // Show progress modal
                showProgressModal();
                updateProgress(0, 'Preparing ZIP archive...', `${photos.length} photos selected`, 'Initializing JSZip...');

                // Create new JSZip instance
                const zip = new JSZip();
                let successCount = 0;
                let failCount = 0;

                // Download and add each photo to ZIP
                for (let i = 0; i < photos.length; i++) {
                    const photo = photos[i];
                    const urlParts = photo.url.split('/');
                    const originalFilename = urlParts[urlParts.length - 1];

                    // Use original filename (important: matches nomor resi!)
                    const filename = originalFilename;

                    try {
                        // Update progress
                        const percent = Math.floor((i / photos.length) * 90); // 0-90% for downloading
                        updateProgress(
                            percent,
                            `Downloading photos... (${i + 1}/${photos.length})`,
                            `Adding ${filename} to ZIP`,
                            `${successCount} successful, ${failCount} failed`
                        );

                        console.log(`📥 Fetching ${i + 1}/${photos.length}: ${filename}`);

                        // Fetch photo as blob
                        const response = await fetch(photo.url);
                        if (!response.ok) throw new Error(`HTTP ${response.status}`);

                        const blob = await response.blob();

                        // Add to ZIP with original filename
                        zip.file(filename, blob);
                        successCount++;

                        console.log(`✅ Added to ZIP: ${filename}`);

                    } catch (error) {
                        failCount++;
                        console.error(`❌ Failed to fetch ${filename}:`, error);
                        // Continue with next photo
                    }
                }

                // Generate ZIP file
                updateProgress(90, 'Creating ZIP file...', 'Compressing photos', `${successCount} photos added`);
                console.log('📦 Generating ZIP file...');

                const zipBlob = await zip.generateAsync({
                    type: 'blob',
                    compression: 'DEFLATE',
                    compressionOptions: { level: 6 }
                }, function updateCallback(metadata) {
                    // Update progress during ZIP generation (90-99%)
                    const percent = 90 + Math.floor(metadata.percent / 10);
                    updateProgress(
                        percent,
                        'Creating ZIP file...',
                        `${metadata.currentFile || 'Finalizing'}`,
                        `Compression: ${metadata.percent.toFixed(1)}%`
                    );
                });

                // Download ZIP file
                updateProgress(99, 'Downloading ZIP...', 'Starting download', 'Almost done!');
                console.log(`📦 ZIP created! Size: ${(zipBlob.size / 1024 / 1024).toFixed(2)} MB`);

                const timestamp = new Date().toISOString().split('T')[0];
                const zipFilename = `photos-${timestamp}-${successCount}items.zip`;

                const blobUrl = window.URL.createObjectURL(zipBlob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = blobUrl;
                a.download = zipFilename;
                document.body.appendChild(a);
                a.click();

                // Cleanup
                setTimeout(() => {
                    window.URL.revokeObjectURL(blobUrl);
                    document.body.removeChild(a);
                }, 100);

                // Complete!
                updateProgress(100, 'Download complete! ✅', `${zipFilename}`, `${successCount} photos, ${(zipBlob.size / 1024 / 1024).toFixed(2)} MB`);
                console.log('✅ ZIP download completed!');

                // Hide modal after 2 seconds
                setTimeout(() => {
                    hideProgressModal();
                    alert(`✅ ZIP berhasil didownload!\n\nFile: ${zipFilename}\nFotos: ${successCount}/${photos.length}\nSize: ${(zipBlob.size / 1024 / 1024).toFixed(2)} MB`);
                }, 2000);

            } catch (error) {
                console.error('❌ ZIP creation error:', error);
                hideProgressModal();
                alert(`❌ Error creating ZIP file: ${error.message}`);
            }
        }

        async function deleteSelected() {
            if (selectedPhotos.size === 0) {
                alert('⚠️ Pilih foto terlebih dahulu');
                return;
            }

            if (!confirm(`Hapus ${selectedPhotos.size} foto yang dipilih?`)) return;

            try {
                // Get auth token
                const token = localStorage.getItem('accessToken');
                if (!token) {
                    throw new Error('No access token found. Please login again.');
                }

                const photos = allPhotos.filter(p => selectedPhotos.has(p.id));

                // Prepare bulk delete payload
                const deletePayload = photos.map(photo => ({
                    entryId: photo.entryId,
                    field: photo.type === 'foto_1' ? 'foto_url_1' : 'foto_url_2'
                }));

                console.log(`🗑️ Bulk deleting ${photos.length} photos...`);

                // Call bulk delete API
                const response = await fetch('/api/foto-management/photos/bulk-delete', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ photos: deletePayload })
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const result = await response.json();

                console.log('📦 Bulk delete result:', result);

                if (result.failCount > 0) {
                    alert(`⚠️ Bulk delete selesai:\n✅ Berhasil: ${result.successCount}\n❌ Gagal: ${result.failCount}`);
                } else {
                    alert(`✅ ${result.successCount} foto berhasil dihapus!`);
                }

                selectedPhotos.clear();
                fetchPhotos();
            } catch (error) {
                console.error('❌ Batch delete error:', error);
                alert('❌ Error deleting photos: ' + error.message);
            }
        }

        // ==========================================
        // REAL-TIME SEARCH
        // ==========================================
        document.getElementById('searchInput').addEventListener('input', function() {
            if (this.value.length > 2 || this.value.length === 0) {
                applyFilters();
            }
        });

        // ==========================================
        // VIEW MODE SWITCHING
        // ==========================================
        function switchViewMode(mode) {
            console.log(`🔄 Switching to ${mode} mode...`);
            viewMode = mode;

            // Update button states
            document.getElementById('paginationModeBtn').classList.toggle('active', mode === 'pagination');
            document.getElementById('infiniteModeBtn').classList.toggle('active', mode === 'infinite');

            // Re-render with new mode
            if (mode === 'pagination') {
                currentPage = 1;
                renderGallery();
            } else {
                renderVirtualScroll();
            }
        }

        // ==========================================
        // VIRTUAL SCROLL CALCULATIONS
        // ==========================================
        function calculateItemsPerRow() {
            const gallery = document.getElementById('photoGallery');
            const galleryWidth = gallery.offsetWidth;

            // Photo card min-width is 220px from CSS: minmax(220px, 1fr)
            const minCardWidth = 220;
            const gap = virtualScrollState.gap; // use gap from state

            // Calculate how many items can fit with proper gaps
            // Formula: (galleryWidth - gap*(n-1)) / n >= minCardWidth
            // Solve for n: galleryWidth / (minCardWidth + gap) gives approximate n
            const itemsPerRow = Math.floor((galleryWidth + gap) / (minCardWidth + gap));
            const result = Math.max(1, itemsPerRow); // at least 1 item per row

            console.log(`📐 Calculate items per row: gallery=${galleryWidth}px, items=${result}`);
            return result;
        }

        // Dynamic height calculation based on actual card
        function updateItemHeight() {
            // Try to measure actual card height from pagination mode
            const cards = document.querySelectorAll('.photo-card');
            if (cards.length > 0) {
                const actualHeight = cards[0].offsetHeight;
                if (actualHeight > 0) {
                    virtualScrollState.itemHeight = actualHeight + virtualScrollState.gap; // add gap between rows
                    console.log(`📏 Updated item height to ${virtualScrollState.itemHeight}px (card=${actualHeight}px + gap=${virtualScrollState.gap}px)`);
                }
            }
        }

        function calculateVisibleRange() {
            const gallery = document.getElementById('photoGallery');
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            const viewportHeight = window.innerHeight;
            const galleryTop = gallery.offsetTop || 0;

            // Calculate relative scroll position within gallery
            const relativeScroll = Math.max(0, scrollTop - galleryTop);

            const state = virtualScrollState;
            const itemsPerRow = state.itemsPerRow;
            const totalRows = Math.ceil(filteredPhotos.length / itemsPerRow);

            // Calculate visible row range
            const startRow = Math.max(0, Math.floor(relativeScroll / state.itemHeight) - state.buffer);
            const endRow = Math.min(totalRows, Math.ceil((relativeScroll + viewportHeight) / state.itemHeight) + state.buffer);

            // Convert to item indices
            const visibleStart = startRow * itemsPerRow;
            const visibleEnd = Math.min(filteredPhotos.length, endRow * itemsPerRow);

            return { visibleStart, visibleEnd, startRow };
        }

        // ==========================================
        // VIRTUAL SCROLL RENDERING
        // ==========================================
        function renderVirtualScroll() {
            const gallery = document.getElementById('photoGallery');

            // Update item height based on actual card dimensions (first time only)
            if (virtualScrollState.itemHeight === 360) {
                updateItemHeight();
            }

            // Calculate items per row dynamically
            virtualScrollState.itemsPerRow = calculateItemsPerRow();

            // Calculate visible range
            const { visibleStart, visibleEnd, startRow } = calculateVisibleRange();
            virtualScrollState.visibleStart = visibleStart;
            virtualScrollState.visibleEnd = visibleEnd;

            // Get visible photos
            const visiblePhotos = filteredPhotos.slice(visibleStart, visibleEnd);

            if (filteredPhotos.length === 0) {
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('photoGallery').style.display = 'none';
                document.getElementById('noPhotosState').style.display = 'block';
                document.getElementById('pagination').style.display = 'none';
                return;
            }

            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('photoGallery').style.display = 'block'; // Change to block for absolute positioning
            document.getElementById('noPhotosState').style.display = 'none';
            document.getElementById('pagination').style.display = 'none'; // Hide pagination in infinite mode

            // Calculate total height
            const totalRows = Math.ceil(filteredPhotos.length / virtualScrollState.itemsPerRow);
            const totalHeight = totalRows * virtualScrollState.itemHeight;

            // Set min-height to maintain scroll space and container for absolute positioning
            gallery.style.minHeight = `${totalHeight}px`;
            gallery.style.position = 'relative';
            gallery.style.width = '100%';
            gallery.style.overflow = 'visible'; // Ensure no clipping

            console.log(`📊 Virtual Scroll Layout: ${totalRows} rows × ${virtualScrollState.itemHeight}px = ${totalHeight}px total height`);

            // Render visible items with offset
            const offsetTop = startRow * virtualScrollState.itemHeight;

            // Pre-calculate dimensions once for all items
            const galleryWidth = gallery.offsetWidth;
            const gap = virtualScrollState.gap;
            const itemsPerRow = virtualScrollState.itemsPerRow;

            // Calculate item width to match CSS grid behavior
            // CSS: grid-template-columns: repeat(auto-fill, minmax(220px, 1fr))
            const totalGaps = gap * (itemsPerRow - 1);
            const itemWidth = (galleryWidth - totalGaps) / itemsPerRow;

            const photosHtml = visiblePhotos.map((photo, index) => {
                const actualIndex = visibleStart + index;
                const date = new Date(photo.created_at);
                const dateStr = date.toLocaleDateString('id-ID');
                const timeStr = date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
                const isSelected = selectedPhotos.has(photo.id);

                const thumbnailUrl = createThumbnailUrl(photo.url);
                const fullSizeUrl = photo.url;
                const urlParts = photo.url.split('/');
                const filename = urlParts[urlParts.length - 1];
                const placeholderSvg = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 300 300'%3E%3Crect fill='%23f5f7fa'/%3E%3C/svg%3E";

                // Calculate position for absolute positioning
                const row = Math.floor(actualIndex / itemsPerRow);
                const col = actualIndex % itemsPerRow;

                // Position with proper gaps
                const left = col * (itemWidth + gap);
                const top = row * virtualScrollState.itemHeight;

                return `
                    <div class="photo-card ${isSelected ? 'selected' : ''}"
                         id="card-${photo.id}"
                         style="position: absolute;
                                top: ${top}px;
                                left: ${left}px;
                                width: ${itemWidth}px;
                                box-sizing: border-box;
                                margin: 0;">
                        <input type="checkbox"
                            class="photo-checkbox"
                            ${isSelected ? 'checked' : ''}
                            onchange="toggleSelect('${photo.id}')"
                        >
                        <div class="photo-img-container">
                            <img src="${placeholderSvg}"
                                data-src="${thumbnailUrl}"
                                data-full="${fullSizeUrl}"
                                alt="${photo.nama}"
                                class="photo-img lazy-loading"
                                onerror="this.src='https://via.placeholder.com/250?text=Error+Loading'"
                            >
                        </div>
                        <div class="photo-info">
                            <div class="photo-name" title="${photo.nama}">${photo.nama}</div>
                            <div class="photo-date">${dateStr} ${timeStr}</div>
                            <div class="photo-size">${photo.type} • Thumbnail</div>
                            <div class="photo-actions">
                                <button class="btn-small btn-view" onclick="viewPhotoLightbox('${fullSizeUrl}')">
                                    <i class="fas fa-eye"></i> View
                                </button>
                                <button class="btn-small btn-download" onclick="downloadPhoto('${fullSizeUrl}', '${filename}')">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button class="btn-small btn-delete" onclick="deletePhoto('${photo.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            gallery.innerHTML = photosHtml;

            // Re-initialize lazy loading
            initLazyLoading();
            updateStats();

            // Update virtual scroll performance info
            const renderedCount = visibleEnd - visibleStart;
            document.getElementById('renderedCount').textContent = renderedCount;
            document.getElementById('virtualScrollInfo').style.display = 'inline';

            console.log(`📊 Virtual Scroll Summary:`);
            console.log(`   - Total photos: ${filteredPhotos.length}`);
            console.log(`   - Items per row: ${itemsPerRow}`);
            console.log(`   - Item dimensions: ${itemWidth.toFixed(2)}px × ${virtualScrollState.itemHeight}px`);
            console.log(`   - Gap: ${gap}px`);
            console.log(`   - Rendered: ${renderedCount} items (${visibleStart}-${visibleEnd})`);
            console.log(`   - Gallery size: ${galleryWidth}px × ${totalHeight}px`);
        }

        // ==========================================
        // SCROLL EVENT HANDLER (THROTTLED)
        // ==========================================
        let scrollTimeout = null;
        function handleVirtualScroll() {
            if (viewMode !== 'infinite') return;

            // Throttle scroll events
            if (scrollTimeout) return;

            scrollTimeout = setTimeout(() => {
                renderVirtualScroll();
                scrollTimeout = null;
            }, 100); // Update every 100ms
        }

        // Attach scroll listener
        window.addEventListener('scroll', handleVirtualScroll);
        window.addEventListener('resize', () => {
            if (viewMode === 'infinite') {
                virtualScrollState.itemsPerRow = calculateItemsPerRow();
                renderVirtualScroll();
            }
        });

        // ==========================================
        // INITIALIZE
        // ==========================================
        fetchPhotos();
        setInterval(fetchPhotos, 60000); // Refresh every minute
    </script>
    <script src="/js/delete-photos.js"></script>
    <script src="cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/sidebar.js"></script>
</body>
</html>
